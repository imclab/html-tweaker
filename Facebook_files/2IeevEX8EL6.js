/*1347314305,173220391*/

if (window.CavalryLogger) { CavalryLogger.start_js(["dBw14"]); }

__d("ChatMessengerPromoTabSheet",["event-extensions","copyProperties","AsyncRequest","ChatConfig","DOM","MercuryParticipants","MercuryThreads","URI","tx","MercuryConstants","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('copyProperties'),h=b('AsyncRequest'),i=b('ChatConfig'),j=b('DOM'),k=c('MercuryConstants'),l=b('MercuryParticipants'),m=b('MercuryThreads'),n=c('ChatTabTemplates'),o=b('URI'),p=b('tx');function q(r,s,t){this._threadID=r;this._rootElement=s;this._sheetView=t;this._sheetHasBeenDisplayed=false;this._canonicalUser=m.getCanonicalUserInThread(r);this._timeoutResetCallback=null;this._template;}g(q.prototype,{render:function(){this._template=n[':fb:mercury:chat:tab-sheet:promo-sheet'].build();if(!this._template)return;var r=l.getIDForUser(this._canonicalUser);l.get(r,function(s){j.setContent(this._template.getNode('text'),p._("{name} is using Messenger. Get the app to chat on the go.",{name:s.short_name}));}.bind(this));this._button=this._template.getNode('installButton');Event.listen(this._template.getNode('installButton'),'click',this.installButtonClickHandler.bind(this));j.setContent(this._rootElement,this._template.getRoot());},rerender:function(){j.empty(this._rootElement);j.setContent(this._template.getNode('text'),"A link has been sent to your phone to install Messenger");j.remove(this._template.getNode('installButton'));j.setContent(this._rootElement,this._template.getRoot());this._timeoutResetCallback(this,i.get('messenger_upsell_post_click_timeout'));},installButtonClickHandler:function(){var r=new o('/ajax/marketing/messenger_send_to_mobile').setQueryData({fb_source:'web_chat_upsell'});new h().setURI(r).setMethod('POST').setHandler(function(u){this.rerender();}.bind(this)).send();var s=i.get('messenger_upsell_impression'),t=s*100;this.setImpressionCount(this._canonicalUser,t);},isPermanent:function(){return false;},timeoutCanBeReset:function(){return true;},setResetTimeoutCallback:function(r){this._timeoutResetCallback=r;},getType:function(){return 'messenger_promo_type';},getCloseTimeout:function(){return i.get('messenger_upsell_promo_timeout');},setImpressionCount:function(r,s){new h().setURI('/ajax/chat/messenger_upsell/update_impressions.php').setData({impressions:s,friend_id:r}).send();i.set('messenger_upsell_impression',s);},displayPromo:function(r){var s=i.get('messenger_upsell_impression'),t=i.get('messenger_upsell_max_impressions');if(this._sheetHasBeenDisplayed||s>=t)return;var u=k.MercurySourceType;if(r){var v=l.getUserID(r.author);if(v!=this._canonicalUser)return;if(r.source==u.CHAT_ORCA||r.source==u.TITAN_ORCA){this._sheetView.open(this);this._sheetHasBeenDisplayed=true;s++;this.setImpressionCount(v,s);return;}}}});e.exports=q;});